# Threads Reference

[â† Back to Documentation](https://github.com/the-can-of-soup/pm_threads/blob/main/Documentation.md)

## Blocks

### `(active thread)` -> Thread
Returns the currently active thread.

This is always the thread that contains the block, because it is impossible to run this block without it being in the active thread.

<details>
  <summary>Internal behavior</summary>
  
  Reads `sequencer.activeThread`.
</details>

### `(active index)` -> Number
Returns the index of the currently active thread.

<details>
  <summary>Internal behavior</summary>
  
  Reads `sequencer.activeThreadIndex` _([I added that!](https://github.com/PenguinMod/PenguinMod-Vm/pull/173) :D)_.
</details>

### `(null thread)` -> Thread
Returns the null thread.

This represents a thread that failed to load or doesn't exist. It has an ID of `undefined`. This thread is also used when the wrong type is inserted into a thread input.

### `(thread at (INDEX v))` -> Thread
_Menus: `INDEX` uses [Index](#index) (get mode)_

Returns the thread that is at `INDEX` in the threads list.

<details>
  <summary>Internal behavior</summary>
  
  Reads from the `runtime.threads` array.
</details>

---

### `(target of [THREAD])` -> Target
Returns the target that is running / ran `THREAD`.

<details>
  <summary>Internal behavior</summary>
  
  Reads the `target` key from the raw thread object.
</details>

### `(id of [THREAD])` -> String
Returns a unique identifier for `THREAD`. This ID is generated by the extension and is not used in the PenguinMod engine.

<details>
  <summary>Internal behavior</summary>
  
  Reads the custom `soupThreadId` key from the raw thread object.
</details>

### `(status [STATUSFORMAT v] of [THREAD])` -> Number
_Menus: `STATUSFORMAT` uses [Status Format](#status-format)_

Returns the current status code of `THREAD`, or the status code in text format if `STATUSFORMAT` is "text". These are the possible values:

| Status # | Status text          | Description                                                  |
|----------|----------------------|--------------------------------------------------------------|
| 0        | Running              | The default status of a thread.[^1]                          |
| 1        | Waiting for promise  | Behavior unknown                                             |
| 2        | Yielded              | Behavior unknown                                             |
| 3        | Yielded for one tick | Behavior unknown                                             |
| 4        | Completed            | The thread is "dead", i.e. it will never run code again.[^1] |
| 5        | Suspended            | Behavior unknown                                             |

<details>
  <summary>Internal behavior</summary>
  
  Reads the `status` key from the raw thread object.
</details>

### `(index of [THREAD])` -> Number
Returns the index of `THREAD` in the list of threads.

<details>
  <summary>Internal behavior</summary>
  
  Uses `soupThreadId` to compare `THREAD` to the threads in the `runtime.threads` array, and returns the index if a match is found.
</details>

---

### `<[THREADONE] is [THREADTWO]>` -> Boolean
Returns `true` if the IDs of the threads match, otherwise returns `false`.

Note that the `<[] = []>` block in Operators will not work for this, as that block compares the stringified value.

<details>
  <summary>Internal behavior</summary>
  
  Uses `soupThreadId` to compare the threads.
</details>

### `<[VALUE] is a thread?>` -> Boolean
Returns `true` if `VALUE` is a thread, otherwise returns `false`.

### `<[THREAD] is null?>` -> Boolean
Returns `true` if `THREAD` is the null thread.

### `<[THREAD] is alive?>` -> Boolean
Returns `true` if `THREAD` is alive, i.e. it is not finished.

<details>
  <summary>Internal behavior</summary>
  
  Returns `true` if the raw thread is in the `runtime.threads` array.
</details>

### `<[THREAD] exited naturally?>` -> Boolean
Returns `true` if `THREAD` is dead, but was not killed, i.e. it exited of its own accord.[^2]

<details>
  <summary>Internal behavior</summary>
  
  Returns `true` if:
  - The raw thread is not in the `runtime.threads` array (therefore it is dead).
  - The raw thread's `isKilled` key is `false`.
  - The raw thead's `status` key is 4 (completed). This catches limbo[^1] cases in which killed threads have `isKilled` set to `false` and `status` unchanged.
</details>

### `<[THREAD] was killed?>` -> Boolean
Returns `true` if `THREAD` exited due to an external cause.[^2]

<details>
  <summary>Internal behavior</summary>
  
  Returns `true` if:
  - The raw thread is not in the `runtime.threads` array (therefore it is dead).
  - Either:
    - The raw thread's `isKilled` key is `true`.
    - The raw thead's `status` key is not 4 (completed). This catches limbo[^1] cases in which killed threads have `isKilled` set to `false` and `status` unchanged.
</details>

### `<[THREAD] was started by clicking in the editor?>` -> Boolean
Returns `true` if `THREAD` was started by manually clicking a stack in the code editor.

<details>
  <summary>Internal behavior</summary>
  
  Returns the `stackClick` key from the raw thread object.
</details>

---

### `yield to next thread` -> Void
Yields.

### `yield [TIMES] times` -> Void
Yields `TIMES` times.

### `yield to previous thread` -> Void
Yields and makes the previous thread active.

<details>
  <summary>Internal behavior</summary>
  
  Decrements `sequencer.activeThreadIndex` twice before yielding. The second decrement is because this value is always incremented by the engine after every yield.
</details>

### `yield to thread at (INDEX v)` -> Void
_Menus: `INDEX` uses [Index](#index) (get mode)_

Yields and makes the thread at the specified index active.

If `INDEX` is larger than the normally accepted range, will immediately end the tick.

<details>
  <summary>Internal behavior</summary>
  
  Sets `sequencer.activeThreadIndex` to 1 less than the desired index before yielding. The decrement is because this value is always incremented by the engine after every yield.
</details>

### `yield to end of tick` -> Void
Yields and immediately ends the tick, skipping all threads that would normally step after this one.

<details>
  <summary>Internal behavior</summary>
  
  Sets `sequencer.activeThreadIndex` to 1 less than the length of `runtime.threads` before yielding. The engine increments the active thread index after every yield, so then it is left at the length of `runtime.threads`, causing the loop in the sequencer to exit, completing the tick.
</details>

---

### `(threads)` -> Array\[Thread\]
Returns all threads that were alive at the start of the current tick in their execution order.

<details>
  <summary>Internal behavior</summary>
  
  Reads the `runtime.threads` array.
</details>



## Menus

### Index

Depending on whether the argument is going to be used as a *get* index or an *insert* index, the menu items will be:

| Get                         | Insert                      |
|-----------------------------|-----------------------------|
| start                       | before start                |
| end                         | after end                   |
| previous index              | before previous             |
| active index                | before active               |
| next index                  | before next                 |
| (you can put an index here) | (you can put an index here) |

For *get* indexes, the value can be overridden by an integer from `0` to the length of the threads list (inclusive).\
For *insert* indexes, the value can be overridden by an integer from `0` to the length of the threads list + 1 (inclusive).

For the value `0`, the behavior of `end` or `after end` is used. Otherwise, the value is used as a 1-based index. In the case of *insert*, the operation will insert the thread(s) **before the specified index**.

### Status Format

| Menu Items |
|------------|
| #          |
| text       |



[^1]: Status is not a reliable indicator for whether a thread is alive. To reliably check if a thread is alive, instead you should use [`<[THREAD] is alive?>`](#thread-is-alive---boolean). This is because in many cases when a thread is stopped, it will enter limbo. Limbo is when a dead thread's status does not get set to 4. Some known cases where a thread enters limbo:
    - When the &nbsp;<img alt="blue flag" style="height: 1em;" src="https://raw.githubusercontent.com/PenguinMod/PenguinMod-Home/refs/heads/main/static/stage_controls/gradient/flag.svg"> blue flag is clicked, all previously running threads will enter limbo.
    - When the &nbsp;<img alt="stop sign" style="height: 1em;" src="https://raw.githubusercontent.com/PenguinMod/PenguinMod-Home/refs/heads/main/static/stage_controls/gradient/stop.svg"> stop sign is clicked, all previously running threads will enter limbo.
    - When a stack restarts because its hat is triggered again, the old thread enters limbo.

[^2]: There are some exceptions where a thread is considered "killed" even though it caused its own termination:
    - When a thread runs `stop [all v]`, it is considered killed.
    - When `stop (SPRITE v)` is run, all threads running as `SPRITE` are considered killed, even if they caused it.
    - When a clone is deleted, all threads running as that clone are considered killed, even if they caused the deletion.
